# Usage of `flutter_genui`

This guidance explains how to quickly get started with the [`flutter_genui`](https://pub.dev/packages/flutter_genui) package.

## Key components

* **`UiAgent`**: The main entry point of the package. It manages the conversation with the LLM, handles UI state, and orchestrates the interaction between the user, the UI, and the AI.

* **`AiClient`**: A client that manages communication with your LLM. The package includes a `FirebaseAiClient` for use with Google's Gemini models via Firebase AI Logic, and you can create your own subclasses for other models.

* **`GenUiSurface`**: A Flutter widget that displays UI generated by the agent. It listens for updates from `UiAgent` and dynamically renders the generated UI.

* **`Catalog`**: A registry of your Flutter widgets that the AI is allowed to generate. For each widget, you define a name, a schema that describes the data needed by the widget, and a builder function.

* **`GenUiManager`**: The core state manager for generated UI. You won't interact directly with this class often, but it's responsible for managing the flow of information and events between the agent and your UI.

## Adding `flutter_genui` to your app

Adding GenUI to your application can be done in a few steps. The steps below show how to perform those steps on a brand new Flutter app (the one created by running `flutter create`).

### Configure Firebase

1. [Create a new Firebase project](https://support.google.com/appsheet/answer/10104995) using the Firebase Console.

1. [Enable Gemini](https://firebase.google.com/docs/gemini-in-firebase/set-up-gemini) for that project.

1. Follow the first three steps in [Firebase's Flutter Setup guide](https://firebase.google.com/docs/flutter/setup) to add Firebase to your app.

1. If you run your Flutter project on the `ios` or `macos` platform, add this key to your
   `{ios,macos}/Runner/*.entitlements` file(s):

    ```xml
    <dict>
    ...
    <key>com.apple.security.network.client</key>
    <true/>
    </dict>
    ```

### Integrate `flutter_genui`

In your `pubspec.yaml` file, add `flutter_genui` and `flutter_genui_firebase_ai` to the `dependencies` section. Right now, it's best to depend directly on the source in this repo.

  ```yaml
  flutter_genui:
    git:
      url: https://github.com/flutter/genui.git
      path: packages/flutter_genui
      ref: 6e472cf0f7416c31a1de6af9a0d1b4cc37188989
  flutter_genui_firebase_ai:
    git:
      url: https://github.com/flutter/genui.git
      path: packages/flutter_genui_firebase_ai
  ```

### Create the connection to an agent

1. Invoke `Firebase.initializeApp`. This should be done when the app is first
   launched, before any calls to `runApp`. The `main` method is a good place
   to do so.

    ```dart
    void main() async {
      WidgetsFlutterBinding.ensureInitialized();
      await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);
      runApp(const MyApp());
    }
    ```

2. In the `State` object of a `StatefulWidget`, create an instance of
   `GenUiManager`. It requires a `Catalog` -- you can give use the built-in
   `CatalogOfCoreItems` to start.

    ```dart
    class _MyHomePageState extended State<MyHomePage> {
      @override
      void initState() {
        super.initState();
        final genUiManager = GenUiManager(catalog: CoreCatalogItems.asCatalog());
      }
    }
    ```

3. Create an instance of `AiClient`. The `FirebaseAiClient` class (which
   connects to Firebase AI Logic) is included with the package and can be used
   here. To start, it will need the tools provided by the `GenUiManager` you
   created earlier and a system instruction. For more information on creating
   system instructions, see [System Instructions](#system-instructions) below.

    ```dart
    class _MyHomePageState extended State<MyHomePage> {
      @override
      void initState() {
        super.initState();

        final genUiManager = GenUiManager(catalog: CoreCatalogItems.asCatalog());

        final aiClient = FirebaseAiClient(
          systemInstruction: '''
            You are an expert in creating funny riddles. Every time I give you a word,
            you should generate UI that displays one new riddle related to that word.
            Each riddle should have both a question and an answer.
            ''',
          tools: genUiManager.getTools(),
        );
      }
    }
    ```

4. Create an instance of `UiAgent`.

    ```dart
    class _MyHomePageState extended State<MyHomePage> {
      @override
      void initState() {
        super.initState();
        
        final genUiManager = GenUiManager(catalog: CoreCatalogItems.asCatalog());
        
        final aiClient = FirebaseAiClient(
          systemInstruction: '''
            You are an expert in creating funny riddles. Every time I give you a word,
            you should generate UI that displays one new riddle related to that word.
            Each riddle should have both a question and an answer.
            ''',
          tools: genUiManager.getTools(),
        );
        
        uiAgent = UiAgent(
          genUiManager: genUiManager,
          aiClient: aiClient,
        );
      }
    }
    ```

### Receive and display generated UI

1. Add `onSurfaceAdded` and `onSurfaceDeleted` methods, so that your app can
   track when the agent generates new UI or deletes UI it no longer needs.

    ```dart
    class _MyHomePageState extended State<MyHomePage> {
      final List<String> _surfaceIds = [];

      void _onSurfaceAdded(SurfaceAdded update) {
        setState(() {
          _surfaceIds.add(update.surfaceId);
        });
      }

      void _onSurfaceDeleted(SurfaceRemoved update) {
        setState(() {
          _surfaceIds.remove(update.surfaceId);
        });
      }

      // ...
    }
    ```

2. Provide these methods as callbacks to `UiAgent`, so that they're invoked
   when surfaces are added or removed by the agent.

    ```dart
    class _MyHomePageState extended State<MyHomePage> {
      @override
      void initState() {
        
        // ...

        uiAgent = UiAgent(
          genUiManager: genUiManager,
          aiClient: aiClient,
          onSurfaceAdded: _onSurfaceAdded,
          onSurfaceDeleted: _onSurfaceDeleted,
        );
      }
    }

3. Update your `build` method to use `GenUiSurface` widgets to display UI
   generated by the agent.

    ```dart
    @override
    Widget build(BuildContext context) {
      return Scaffold(
        appBar: AppBar(
          backgroundColor: Theme.of(context).colorScheme.inversePrimary,
          title: Text(widget.title),
        ),
        body: Column(
          children: [
            Expanded(
              child: ListView.builder(
                itemCount: _surfaceIds.length,
                itemBuilder: (context, index) {
                  final id = _surfaceIds[index];
                  return GenUiSurface(
                    host: uiAgent.host,
                    surfaceId: id,
                  );
                },
              ),
            ),
          ],
        ),
      );
    }
    ```

4. Create a method to send user input to the `UiAgent`.

    ```dart
    class _MyHomePageState extends State<MyHomePage> {
      void _sendMessage(String text) {
        if (text.trim().isEmpty) return;
        uiAgent.sendRequest(UserMessage.text(text));
      }

      // ...
    }
    ```

5. Add UI to accept text from the user and call `sendMessage`.

    ```dart
    class _MyHomePageState extends State<MyHomePage> {
      final _textController = TextEditingController();  // New

      // ...

      @override
      Widget build(BuildContext context) {
        return Scaffold(
          // ...
          body: Column(
            children: [
              Expanded(
                child: ListView.builder(
                  itemCount: _surfaceIds.length,
                  itemBuilder: (context, index) {
                    final id = _surfaceIds[index];
                    return GenUiSurface(
                      host: uiAgent.host,
                      surfaceId: id,
                    );
                  },
                ),
              ),
              SafeArea( // New
                child: Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 16.0),
                  child: Row(
                    children: [
                      Expanded(
                        child: TextField(
                          controller: _textController,
                          decoration: const InputDecoration(
                            hintText: 'Enter a message',
                          ),
                        ),
                      ),
                      const SizedBox(width: 16),
                      ElevatedButton(
                        onPressed: () {
                          _sendMessage(_textController.text);
                          _textController.clear();
                        },
                        child: const Text('Send'),
                      ),
                    ],
                  ),
                ),
              ),
            ],
          ),
        );
      }
    }
    ```

## Next steps

Check out the [examples](../examples) included in this repo! The [travel app](../examples/travel_app) shows how to define your own widget `Catalog` that the agent can generate.

If something is unclear or missing, please [create an issue](https://github.com/flutter/genui/issues/new/choose).

## System Instructions

The `flutter_genui` package offers tools to an LLM that it can use to generate UI elements rather than responding purely in text. In order to get the LLM to _use_ those tools, you'll need to instruct it to do so via your system instruction. Some 

## Troubleshooting / FAQ

### How can I configure logging?

To observe interaction between your app and the agent, enable logging in your `main` method.

```dart
import 'package:logging/logging.dart';

final logger = configureGenUiLogging(level: Level.ALL);

void main() async {
  logger.onRecord.listen((record) {
    debugPrint('${record.loggerName}: ${record.message}');
  });

  // ...
}
```

### I'm getting errors about my minimum macOS/iOS version.

Firebase has a [minimum version requirement](https://firebase.google.com/support/release-notes/ios) for Apple's platforms, which may be higher than Flutter's. Check your `ios` and `macOS` subprojects to make sure you're using a minimum version that meets or exceeds Firebase's requriements.

### Can I download this package from [pub.dev](https://pub.dev)?

Yes, though the published version is currently behind what's available directly from this repo. Once the package has reached a greater level of API stability, you can expect more frequent publication.
